Fix bugs and improve performance